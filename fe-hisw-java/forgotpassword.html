<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot password</title>
    <link rel="stylesheet" href="css/forgotpasswordstyle.css">
</head>

<body>

    <div class="forgot-password-container">
        <div id="step1">
            <form id="sendOtpForm">
                <h1>Forgot password</h1>
                <p>Please enter to receive a verification code.</p>

                <p id="error-message-step1" class="error-message"></p>

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="Enter registered email" required>
                </div>

                <button type="submit" id="sendOtpButton">Send OTP</button>
            </form>
        </div>

        <div id="step2" style="display: none;">
            <form id="resetPasswordForm">
                <h2>Reset password</h2>
                <p>An OTP code has sent to your mail. Please enter this code and your new password.</p>

                <p id="error-message-step2" class="error-message"></p>

                <div class="input-group">
                    <label for="otp">OTP Code</label>
                    <input type="text" id="otp" name="otp" placeholder="Enter OTP code" required>
                </div>
                <div class="input-group">
                    <label for="newPassword">New password</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="Enter your new password" required>
                </div>
                <div class="input-group">
                    <label for="confirmNewPassword">Confirm your new password</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword"
                        placeholder="Enter your new password again" required>
                </div>

                <button type="submit" id="resetButton">Confirm</button>
            </form>
        </div>

        <div class="links">
            <a href="login.html">Return to login page</a>
        </div>
    </div>

    <script>
        // Lấy các element từ DOM
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const sendOtpForm = document.getElementById('sendOtpForm');
        const resetPasswordForm = document.getElementById('resetPasswordForm');

        const errorMessageStep1 = document.getElementById('error-message-step1');
        const errorMessageStep2 = document.getElementById('error-message-step2');

        // **Định nghĩa URL gốc của API để dễ dàng thay đổi**
        const baseUrl = 'http://localhost:8286/api/auth';

        // Biến để lưu email người dùng giữa các bước
        let userEmail = '';

        // Xử lý sự kiện cho Form Gửi OTP (Bước 1)
        sendOtpForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const sendOtpButton = document.getElementById('sendOtpButton');
            sendOtpButton.disabled = true;
            sendOtpButton.textContent = 'Đang gửi...';
            errorMessageStep1.textContent = '';

            const emailInput = document.getElementById('email');
            userEmail = emailInput.value;

            try {
                // **Sử dụng biến baseUrl**
                const response = await fetch(`${baseUrl}/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });

                if (response.ok) {
                    step1.style.display = 'none';
                    step2.style.display = 'block';
                } else {
                    const errorText = await response.text();
                    errorMessageStep1.textContent = errorText || 'Email không tồn tại trong hệ thống.';
                }
            } catch (error) {
                errorMessageStep1.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
            } finally {
                sendOtpButton.disabled = false;
                sendOtpButton.textContent = 'Send OTP';
            }
        });

        // Xử lý sự kiện cho Form Đặt lại mật khẩu (Bước 2)
        resetPasswordForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const resetButton = document.getElementById('resetButton');
            resetButton.disabled = true;
            resetButton.textContent = 'Đang xử lý...';
            errorMessageStep2.textContent = '';

            const otp = document.getElementById('otp').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                errorMessageStep2.textContent = 'Mật khẩu xác nhận không khớp.';
                resetButton.disabled = false;
                resetButton.textContent = 'Xác Nhận';
                return;
            }

            try {
                // **Sử dụng biến baseUrl**
                const response = await fetch(`${baseUrl}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        otp: otp,
                        newPassword: newPassword
                    })
                });

                if (response.ok) {
                    alert('Đặt lại mật khẩu thành công! Vui lòng đăng nhập lại.');
                    window.location.href = 'login.html';
                } else {
                    const errorText = await response.text();
                    errorMessageStep2.textContent = errorText || 'Mã OTP không hợp lệ hoặc đã hết hạn.';
                }
            } catch (error) {
                errorMessageStep2.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
            } finally {
                resetButton.disabled = false;
                resetButton.textContent = 'Xác Nhận';
            }
        });
    </script>
</body>

</html>