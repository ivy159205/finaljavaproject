<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | Admin Dashboard</title>
    <script src="https://unpkg.com/jwt-decode@3.1.2/build/jwt-decode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <div class="admin-container">
        <div class="header">
            <h1><i class="fas fa-users-cog"></i> Administrator page</h1>
            <p>Manage and monitor all users in your system</p>
            <button id="logout-button" class="btn btn-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <div class="controls-section">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="search" id="search-input" class="search-input"
                    placeholder="Search by username or email...">
                <button type="button" id="clear-search-button" class="clear-search-btn" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="action-buttons">
                <button id="export-button" class="btn btn-success">
                    <i class="fas fa-download"></i> Export Excel
                </button>
                <button id="refresh-button" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="total-users">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="admin-count">0</div>
                <div class="stat-label">Admins</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="user-count">0</div>
                <div class="stat-label">Regular Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="filtered-count">0</div>
                <div class="stat-label">Filtered Results</div>
            </div>
        </div>

        <div id="error" class="message-banner error" style="display: none;"></div>
        <div id="success" class="message-banner success" style="display: none;"></div>
        <div id="loading" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p>Loading data...</p>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Contact Information</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === DOM Elements ===
            const API_BASE_URL = 'http://localhost:8286/api';
            const userTableBody = document.getElementById('user-table-body');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            const exportButton = document.getElementById('export-button');
            const refreshButton = document.getElementById('refresh-button');
            const searchInput = document.getElementById('search-input');
            const clearSearchButton = document.getElementById('clear-search-button');
            const logoutButton = document.getElementById('logout-button');

            // Stats elements
            const totalUsersEl = document.getElementById('total-users');
            const adminCountEl = document.getElementById('admin-count');
            const userCountEl = document.getElementById('user-count');
            const filteredCountEl = document.getElementById('filtered-count');

            // === State ===
            let allUsersData = [];
            let filteredUsersData = [];

            // === Functions ===
            const fetchUsers = async (token) => {
                showLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                    allUsersData = await response.json();
                    console.log("Data structure of a user from API:", allUsersData[0]);
                    filteredUsersData = [...allUsersData];
                    renderUsers(filteredUsersData);
                    updateStats();
                } catch (error) {
                    console.error('Failed to fetch user data:', error);
                    showMessage('error', 'Could not load user data. Please try again.');
                } finally {
                    showLoading(false);
                }
            };

            const renderUsers = (users) => {
                filteredUsersData = users; // Update the currently filtered list
                if (users.length === 0) {
                    userTableBody.innerHTML = `<tr><td colspan="4" class="empty-state"><h3><i class="fas fa-info-circle"></i> No Users Found</h3><p>No data matches your criteria.</p></td></tr>`;
                } else {
                    userTableBody.innerHTML = users.map(user => {
                        const avatar = user.username ? user.username.charAt(0).toUpperCase() : 'U';
                        const roleClass = user.role == 'admin' ? 'role-admin' : 'role-user'; // Edit here
                        const roleName = user.role == 'admin' ? 'Admin' : 'User'; // And here
                        return `
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="user-avatar">${avatar}</div>
                                    <div>
                                        <div class="user-name">${user.username || 'N/A'}</div>
                                        <div class="user-id">ID: ${user.userId}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="contact-cell">
                                    <div class="user-email"><i class="fas fa-envelope"></i> ${user.email}</div>
                                    <div class="user-phone"><i class="fas fa-phone"></i> ${user.phoneNumber || 'No Phone Number'}</div>
                                </div>
                            </td>
                            <td><span class="role-badge ${roleClass}">${roleName}</span></td>
                            <td>
                                <button class="btn btn-delete" data-id="${user.userId}" title="Delete user">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    }).join('');
                }
                updateStats(); // Update the stats again
            };

            const updateStats = () => {
                const total = allUsersData.length;
                const admins = allUsersData.filter(u => u.role == 'admin').length; // Edit here
                totalUsersEl.textContent = total;
                adminCountEl.textContent = admins;
                userCountEl.textContent = total - admins;
                filteredCountEl.textContent = filteredUsersData.length;
            };

            const filterUsers = () => {
                const keyword = searchInput.value.trim().toLowerCase();
                clearSearchButton.style.display = keyword ? 'flex' : 'none';
                const filtered = allUsersData.filter(user =>
                    (user.username || '').toLowerCase().includes(keyword) ||
                    (user.email || '').toLowerCase().includes(keyword)
                );
                renderUsers(filtered);
            };

            const handleDeleteUser = async (userId) => {
                const user = allUsersData.find(u => u.userId == userId);
                const userName = user ? user.username || user.email : `ID ${userId}`;
                if (confirm(`Are you sure you want to delete the user "${userName}"?`)) {
                    const token = localStorage.getItem('jwtToken');
                    showLoading(true);
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) throw new Error('Delete operation failed.');
                        showMessage('success', 'User deleted successfully!');
                        await fetchUsers(token); // Reload data
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        showMessage('error', 'Could not delete user. Please try again.');
                    } finally {
                        showLoading(false);
                    }
                }
            };

            const handleExportToExcel = () => {
                if (filteredUsersData.length === 0) {
                    showMessage('error', 'No data to export.');
                    return;
                }
                const dataToExport = filteredUsersData.map(user => ({
                    'ID': user.userId, 'Username': user.username, 'Email': user.email,
                    'Phone': user.phoneNumber, 'Gender': user.gender, 'Role': user.role,
                    'Date of Birth': user.dob
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Users");
                XLSX.writeFile(workbook, `Users_Export_${new Date().toISOString().slice(0, 10)}.xlsx`);
                showMessage('success', 'Data exported to Excel successfully!');
            };

            const handleLogout = () => {
                localStorage.removeItem('jwtToken'); // Remove token
                window.location.href = 'login.html'; // Redirect to login page
            };

            const showLoading = (isLoading) => { loadingDiv.style.display = isLoading ? 'flex' : 'none'; };

            const showMessage = (type, message) => {
                const element = type === 'success' ? successDiv : errorDiv;
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => { element.style.display = 'none'; }, 4000);
            };

            // === Initialization ===
            const init = () => {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    showMessage('error', 'Token not found. Please login.');
                    document.querySelector('.admin-container').innerHTML = '<h1><i class="fas fa-lock"></i> Access Denied</h1>';
                    return;
                }
                try {
                    const decodedToken = jwt_decode(token);
                    if (decodedToken.exp * 1000 < Date.now()) {
                        showMessage('error', 'Session has expired.');
                        return;
                    }
                    if (decodedToken.role == 'ROLE_ADMIN') {
                        fetchUsers(token);
                    } else {
                        showMessage('error', 'Admin rights required.');
                        document.querySelector('.admin-container').innerHTML = '<h1><i class="fas fa-lock"></i> Access Denied</h1>';
                    }
                } catch (e) {
                    showMessage('error', 'Invalid token.');
                }
            };

            // === Event Listeners ===
            userTableBody.addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.btn-delete');
                if (deleteButton) {
                    handleDeleteUser(deleteButton.dataset.id);
                }
            });

            refreshButton.addEventListener('click', () => {
                searchInput.value = '';
                init(); // Rerun init to get the latest token and fetch
                showMessage('success', 'Data has been refreshed!');
            });

            exportButton.addEventListener('click', handleExportToExcel);
            searchInput.addEventListener('input', filterUsers);
            logoutButton.addEventListener('click', handleLogout);
            clearSearchButton.addEventListener('click', () => {
                searchInput.value = '';
                filterUsers();
            });

            init();
        });
    </script>
</body>

</html>